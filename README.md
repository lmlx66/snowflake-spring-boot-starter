# å¼€ç®±å³ç”¨çš„javaé›ªèŠ±ç®—æ³•ï¼ˆyitter-idgenerator-spring-boot-starterï¼‰

### 1ã€ä»‹ç»

é›ªèŠ±ç®—æ³•æ˜¯ä¸€ä¸ªåˆ†å¸ƒå¼ä¸»é”®idç”Ÿæˆçš„è§£å†³æ–¹æ¡ˆï¼Œä»–è§£å†³äº†åˆ†å¸ƒå¼idç”Ÿæˆçš„ç—›ç‚¹é—®é¢˜ï¼Œæœ¬ç®—æ³•åŸºäºæ¨ç‰¹é›ªèŠ±ç®—æ³•ï¼Œè¿›è¡Œæ·±åº¦ä¼˜åŒ–ã€‚

ç®—æ³•åŸºäº[SnowFlake IdGenerator](https://gitee.com/yitter/idgenerator)æ ¸å¿ƒä»£ç å¼€å‘ï¼Œå¼•å…¥springbootè‡ªåŠ¨é…ç½®ï¼Œä»è€Œåšåˆ°å¼€ç®±å³ç”¨çš„æ•ˆæœã€‚è¯¥ç®—æ³•åœ¨ç¼©çŸ­IDé•¿åº¦çš„åŒæ—¶ï¼Œå…·å¤‡æé«˜ç¬æ—¶å¹¶å‘å¤„ç†èƒ½åŠ›ï¼ˆ50W/0.1sï¼‰ï¼Œä¸”æ”¯æŒæ—¶é—´å›æ‹¨ã€‚

**å¦‚æœä½ è§‰å¾—å¥½ç”¨ï¼Œè¯·ç‚¹ä¸€ä¸ªstarï¼Œè¿™å¯¹æˆ‘æ¥è¯´éå¸¸é‡è¦ï¼Œè°¢è°¢ï¼ï¼ï¼**


### 2ã€æŠ€æœ¯æ”¯æŒ

æœ¬ç®—æ³•åŸºäº[å¤šè¯­è¨€æ–°é›ªèŠ±ç®—æ³•(SnowFlake IdGenerator)](https://gitee.com/yitter/idgenerator)æ ¸å¿ƒä»£ç å®ç°ï¼Œå…³äºè¯¥ç®—æ³•æ›´å¤šç»†èŠ‚è¯·å‚é˜…é¡¹ç›®åœ°å€ã€‚



### 3ã€ç®—æ³•ç‰¹ç‚¹

âœ” æ•´å½¢æ•°å­—ï¼Œéšæ—¶é—´å•è°ƒé€’å¢ï¼ˆä¸ä¸€å®šè¿ç»­ï¼‰ï¼Œé•¿åº¦æ›´çŸ­ï¼Œç”¨50å¹´éƒ½ä¸ä¼šè¶…è¿‡ js Numberç±»å‹æœ€å¤§å€¼ã€‚ï¼ˆé»˜è®¤é…ç½®ï¼‰

âœ” é€Ÿåº¦æ›´å¿«ï¼Œæ˜¯ä¼ ç»Ÿé›ªèŠ±ç®—æ³•çš„2-5å€ï¼Œ0.1ç§’å¯ç”Ÿæˆ50ä¸‡ä¸ªï¼ˆåŸºäº8ä»£ä½å‹i7ï¼‰ã€‚

âœ” æ”¯æŒæ—¶é—´å›æ‹¨å¤„ç†ã€‚æ¯”å¦‚æœåŠ¡å™¨æ—¶é—´å›æ‹¨1ç§’ï¼Œæœ¬ç®—æ³•èƒ½è‡ªåŠ¨é€‚åº”ç”Ÿæˆä¸´ç•Œæ—¶é—´çš„å”¯ä¸€IDã€‚

âœ” æ”¯æŒæ‰‹å·¥æ’å…¥æ–°IDã€‚å½“ä¸šåŠ¡éœ€è¦åœ¨å†å²æ—¶é—´ç”Ÿæˆæ–°IDæ—¶ï¼Œç”¨æœ¬ç®—æ³•çš„é¢„ç•™ä½èƒ½ç”Ÿæˆ5000ä¸ªæ¯ç§’ã€‚

âœ” ä¸ä¾èµ–ä»»ä½•å¤–éƒ¨ç¼“å­˜å’Œæ•°æ®åº“ã€‚ï¼ˆk8sç¯å¢ƒä¸‹è‡ªåŠ¨æ³¨å†Œ WorkerId çš„åŠ¨æ€åº“ä¾èµ– redisï¼‰

âœ” åŸºç¡€åŠŸèƒ½ï¼Œå¼€ç®±å³ç”¨ï¼Œæ— éœ€é…ç½®æ–‡ä»¶ã€æ•°æ®åº“è¿æ¥ç­‰ã€‚

âœ”æ”¯æŒå¾®æœåŠ¡åŠ¨æ€é…ç½®ï¼Œä¼šåŠ¨æ€åŠ è½½å•ä¾‹beanï¼Œé€šè¿‡åŠ¨æ€åŠ è½½é…ç½®æ–‡ä»¶ï¼Œè€Œå®ç°è‡ªåŠ¨æ³¨å†Œæœºå™¨ç ã€‚

âœ”æ”¯æŒæ•°æ®ä¸­å¿ƒidåˆ†é…ï¼Œæ›´è´´è¿‘å®é™…ç”Ÿäº§ç¯å¢ƒã€‚



### 4ã€å¦‚ä½•ä½¿ç”¨

å½“ç„¶ï¼Œæˆ‘ä¹Ÿä¸ºä½ å‡†å¤‡äº†ä¸€ä¸ªdemoï¼š[æ–°å‹é›ªèŠ±ç®—æ³•å¾®æœåŠ¡demo](https://gitee.com/lmlx66/hy-id-generator-demo)



#### 4.1ã€é€šç”¨æ­¥éª¤



##### 4.1.1ã€å¼•å…¥ç›¸å…³maven

[mavenä»“åº“åœ°å€](https://repo1.maven.org/maven2/io/github/lmlx66/)

æˆ‘ä»¬é€šè¿‡æ˜¯å¦ä½¿ç”¨åŠ¨æ€é…ç½®ï¼Œæ˜¯å¦ä½¿ç”¨mybatis-plusï¼Œåˆ†å‡ºäº†å››ä¸ªåŒ…ï¼Œè¯·ä½ æŒ‰éœ€å¼•å…¥ã€‚


**1.å‡å¦‚ä½ ä¸éœ€è¦ä½¿ç”¨åŠ¨æ€é…ç½®ï¼Œä¸éœ€è¦æ•´åˆmybatis-plusä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œåˆ™å¼•å…¥å·¥ä»¶åï¼š`yitter-idgenerator-spring-boot-starter`ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š**

mavenï¼š

```xml
<dependency>
  <groupId>io.github.lmlx66</groupId>
  <artifactId>yitter-idgenerator-spring-boot-starter</artifactId>
  <version>1.1.0-RELEASE</version>
</dependency>
```

Gradleï¼š

```gradle
implementation 'io.github.lmlx66:yitter-idgenerator-spring-boot-starter:1.1.0-RELEASE'
```



**2.ä¸éœ€è¦åŠ¨æ€é…ç½®ï¼Œéœ€è¦mybatis-plusä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œåˆ™å¼•å…¥å·¥ä»¶åï¼š`yitter-idgenerator-mybatisPlus-spring-boot-starter`**

mavenï¼š

```xml
<dependency>
  <groupId>io.github.lmlx66</groupId>
  <artifactId>yitter-idgenerator-mybatisPlus-spring-boot-starter</artifactId>
  <version>1.1.0-RELEASE</version>
</dependency>
```

Gradleï¼š

```gradle
implementation 'io.github.lmlx66:yitter-idgenerator-mybatisPlus-spring-boot-starter:1.1.0-RELEASE'
```



**3.éœ€è¦åŠ¨æ€é…ç½®ï¼Œä¸éœ€è¦mybatis-plusä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œåˆ™å¼•å…¥å·¥ä»¶åï¼š`yitter-idgenerator-spring-cloud-starter`**

mavenï¼š

```xml
<dependency>
  <groupId>io.github.lmlx66</groupId>
  <artifactId>yitter-idgenerator-spring-cloud-starter</artifactId>
  <version>1.1.0-RELEASE</version>
</dependency>
```

Gradleï¼š

```gradle
implementation 'io.github.lmlx66:yitter-idgenerator-spring-cloud-starter:1.1.0-RELEASE'
```



**4..éœ€è¦åŠ¨æ€é…ç½®ï¼Œéœ€è¦mybatis-plusä¸»é”®ç”Ÿæˆç­–ç•¥ï¼Œåˆ™å¼•å…¥å·¥ä»¶åï¼š`yitter-idgenerator-mybatisPlus-spring-cloud-starter`**

mavenï¼š

```xml
<dependency>
  <groupId>io.github.lmlx66</groupId>
  <artifactId>yitter-idgenerator-mybatisPlus-spring-cloud-starter</artifactId>
  <version>1.1.0-RELEASE</version>
</dependency>
```

Gradleï¼š

```gradle
implementation 'io.github.lmlx66:yitter-idgenerator-mybatisPlus-spring-cloud-starter:1.1.0-RELEASE'
```



##### 4.1.2ã€å¦‚ä½•ä½¿ç”¨

æ³¨å…¥ç”Ÿæˆå™¨`WFGIdGenerator`å¹¶è°ƒç”¨`next`æ–¹æ³•ï¼Œè‡³äºä¸ºä»€ä¹ˆæ˜¯`WGF`å‘¢ï¼Ÿæˆ‘ç½‘åå«`ç‹å¯Œè´µ`

``` java
@RestController
public class IdController {
   
    @Autowired
    private WFGIdGenerator wFGIdGenerator;
    
    @GetMapping("getId")
    public long getId(){
        return wFGIdGenerator.next();
    } 
}
```

æ˜¯ä¸æ˜¯éå¸¸ç®€å•å‘¢ï¼Ÿ



##### 4.1.3ã€yamlé…ç½®

å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å¯¹é›ªèŠ±ç®—æ³•ç®€å•çš„é…ç½®ä¸€ä¸‹ï¼Œyamlæ–‡ä»¶ç¤ºä¾‹å¦‚ä¸‹ï¼š

```yaml
wfg:
  method: 1 # 1ä¸ºé›ªèŠ±æ¼‚ç§»ç®—æ³•ï¼Œ2ä¸ºä¼ ç»Ÿç®—æ³•
  worker-id: 2 # æœºå™¨ç id
```



#### 4.2ã€æ•´åˆmybatis-plus

å¦‚æœä½ æ•´åˆçš„æ˜¯mybatis-plusç‰ˆæœ¬ï¼Œåœ¨å®ä½“ç±»ä¸Šä½¿ç”¨æ³¨è§£`@TableId(value = "å¯¹åº”è¡¨å­—æ®µå", type = IdType.ASSIGN_ID)`ï¼Œåˆ™æ’å…¥è¯¥å­—æ®µä¸ºnullä¼šä½¿ç”¨æˆ‘ä»¬çš„é›ªèŠ±ç®—æ³•ç”Ÿæˆä¸€ä¸ªidã€‚

å…¶ä¸­é‡è¦çš„æ˜¯`type`å¿…é¡»ä¸º`IdType.ASSIGN_ID`ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š

```java
public class YourEntity {
    @TableId(value = "id", type = IdType.ASSIGN_ID)
    private String id;
}
```



### 5ã€é…ç½®è¯¦è§£



#### 5.1ã€é…ç½®æ–‡ä»¶é…ç½®

æˆ‘ä»¬æ”¯æŒåœ¨yamlæˆ–è€…propertiesç­‰é…ç½®æ–‡ä»¶ä¸­é…ç½®ï¼Œæ³¨æ„å‰ç¼€ä¸º`wfg`

| å‚æ•°å                | é»˜è®¤å€¼        | ä½œç”¨                                            |
| --------------------- | ------------- | ----------------------------------------------- |
| Methodï¼ˆshortï¼‰       | 1             | 1è¡¨ç¤ºé›ªèŠ±æ¼‚ç§»ç®—æ³•ï¼Œ2è¡¨ç¤ºä¼ ç»Ÿé›ªèŠ±ç®—æ³•            |
| BaseTimeï¼ˆlongï¼‰      | 1640966400000 | åŸºç¡€æ—¶é—´ï¼Œä¸º2022-01-01 00:00:00                 |
| DataCenterId          | 0             | æ•°æ®ä¸­å¿ƒid                                      |
| DataCenterIdBitLength | 0             | æ•°æ®ä¸­å¿ƒidä½é•¿ï¼Œé»˜è®¤ä¸º0è¡¨ç¤ºä¸å¼€å¯æ•°æ®ä¸­å¿ƒidåŠŸèƒ½ |
| WorkerIdBitLength     | 1             | æœºå™¨ç ä½é•¿ï¼ˆèƒ½è¡¨ç¤ºæœºå™¨ç çš„æœ€å¤§å€¼ï¼‰              |
| WorkerId              | 0             | æœºå™¨ç ï¼ˆå½“å‰ç³»ç»Ÿçš„æœºå™¨ç ï¼‰                      |
| SeqBitLength          | 6             | åºåˆ—æ•°ä½é•¿ï¼ˆèƒ½è¡¨ç¤ºæœºå™¨ç çš„æœ€å¤§åºåˆ—æ•°ï¼‰          |
| MaxSeqNumber          | 0ï¼ˆä¸é™åˆ¶ï¼‰   | æœ€å¤§åºåˆ—æ•°ï¼ˆå«ï¼‰                                |
| MinSeqNumber          | 5ï¼ˆä¸é™åˆ¶ï¼‰   | æœ€å°åºåˆ—æ•°ï¼ˆå«ï¼‰                                |
| TopOverCostCount      | 2000          | æœ€å¤§æ¼‚ç§»æ¬¡æ•°ï¼Œä¸è®¡ç®—èƒ½åŠ›æœ‰å…³                    |



#### 5.2ã€é…ç½®ç±»é…ç½®

å½“ç„¶ï¼Œæˆ‘ä»¬ä¹Ÿæ”¯æŒé…ç½®ç±»é…ç½®ï¼Œè¿”å›ç±»å‹ä¸ºWFGIdGeneratorï¼Œå…¶æ„é€ éœ€è¦ä¸€ä¸ªIdGeneratorPropertiesç±»å‹ã€‚

IdGeneratorPropertiesæ˜¯åŸºç¡€é…ç½®ç±»å®ä½“æ˜ å°„ç±»ï¼Œå…¶å†…éƒ¨å±æ€§å³æˆ‘ä»¬å¯é…ç½®çš„å±æ€§ã€‚

ä½†è¯·æ³¨æ„ï¼Œå¦‚æœé…ç½®ç±»å’Œé…ç½®æ–‡ä»¶ï¼ˆyamlæˆ–propertiesï¼‰åŒæ—¶ä½¿ç”¨ï¼Œä¼˜å…ˆé‡‡ç”¨é…ç½®ç±»é…ç½®ã€‚

```java
@Configuration
public class IdGeneratorConfig {
    @Bean
    public WFGIdGenerator wFGIdGenerator() {
         //å‡†å¤‡åŸºç¡€é…ç½®ç±»ï¼Œåœ¨æ­¤å¯ä»¥é…ç½®åŸºç¡€ä¿¡æ¯
        IdGeneratorOptions idGeneratorOptions = new IdGeneratorOptions();
        idGeneratorOptions.setWorkerId((short) 6); //è®¾ç½®æœºå™¨ç ä¸º6
        idGeneratorOptions.setWorkerIdBitLength((byte) 3); //è®¾ç½®æœºå™¨ç ä½é•¿ä¸º3
        //è£…è½½idç”Ÿæˆå™¨çš„é…ç½®æ–‡ä»¶
        return new wFGIdGenerator(idGeneratorOptions);
    }
}
```



##### 5.2.1ã€é…ç½®ä¼˜å…ˆçº§

è¯·æ³¨æ„æˆ‘ä»¬çš„ä¼˜å…ˆçº§ï¼Œæœ¬åœ°é…ç½®æ–‡ä»¶é…ç½®ï¼ˆæœ¬åœ°yamlæ–‡ä»¶æˆ–propertiesæ–‡ä»¶ï¼‰ **<** é…ç½®ç±»é…ç½®ï¼ˆè‡ªå·±åˆ›å»ºbeanï¼‰ **<** é…ç½®ä¸­å¿ƒé…ç½®ï¼ˆå¦‚nacos-configé…ç½®ï¼‰

åŸå› å¦‚ä¸‹ï¼šé…ç½®ä¸­å¿ƒé…ç½®ä¿®æ”¹æ—¶ä¼šé‡æ–°åŠ è½½bean



#### 5.3ã€å‚æ•°è¯¦è§£

â„**Method**ï¼Œè¡¨ç¤ºä½¿ç”¨ä»€ä¹ˆç®—æ³•ï¼Œ**é»˜è®¤å€¼ä¸º1**ï¼Œè¡¨ç¤ºä½¿ç”¨é›ªèŠ±æ¼‚ç§»ç®—æ³•ï¼Œ2è¡¨ç¤ºä½¿ç”¨ä¼ ç»Ÿé›ªèŠ±ç®—æ³•ã€‚ä½†ä»å»ºè®®ä½ ä½¿ç”¨é›ªèŠ±æ¼‚ç§»ç®—æ³•ï¼ˆMethod=1ï¼Œé»˜è®¤çš„ï¼‰ï¼Œæ¯•ç«Ÿå®ƒå…·æœ‰æ›´å¥½çš„ä¼¸ç¼©åŠ›å’Œæ›´é«˜çš„æ€§èƒ½ã€‚

â„ ***BaseTime***ï¼ŒåŸºç¡€æ—¶é—´ï¼ˆä¹Ÿç§°ï¼šåŸºç‚¹æ—¶é—´ã€åŸç‚¹æ—¶é—´ã€çºªå…ƒæ—¶é—´ï¼‰ï¼Œé»˜è®¤å€¼ä¸ºï¼š**2022-01-01 00:00:00**ï¼Œæ˜¯æ¯«ç§’æ—¶é—´æˆ³ï¼ˆæ˜¯æ•´æ•°ï¼Œ.NETæ˜¯DatetTimeç±»å‹ï¼‰ï¼Œä½œç”¨æ˜¯ï¼šç”¨ç”ŸæˆIDæ—¶çš„ç³»ç»Ÿæ—¶é—´ä¸åŸºç¡€æ—¶é—´çš„å·®å€¼ï¼ˆæ¯«ç§’æ•°ï¼‰ä½œä¸ºç”ŸæˆIDçš„æ—¶é—´æˆ³ã€‚åŸºç¡€æ—¶é—´ä¸€èˆ¬æ— éœ€è®¾ç½®ï¼Œå¦‚æœè§‰å¾—é»˜è®¤å€¼å¤ªè€ï¼Œä½ å¯ä»¥é‡æ–°è®¾ç½®ï¼Œä¸è¿‡è¦æ³¨æ„ï¼Œè¿™ä¸ªå€¼ä»¥åæœ€å¥½ä¸å˜ã€‚

â„**DataCenterId**ï¼Œ  æ•°æ®ä¸­å¿ƒidï¼Œ**é»˜è®¤å€¼0**ï¼Œå¿…é¡» **å…¨å±€å”¯ä¸€**ï¼ˆæˆ–ç›¸åŒ DataCenterId å†…å”¯ä¸€ï¼‰ï¼Œå¿…é¡» **ç¨‹åºè®¾å®š**ï¼Œç¼ºçœæ¡ä»¶ï¼ˆDataCenterIdBitLengthå–æœ€å¤§å€¼6ï¼‰æ—¶æœ€å¤§å€¼63ï¼Œè¡¨ç¤ºæ”¯æŒ63ä¸ªæ•°æ®ä¸­å¿ƒã€‚

â„**DataCenterIdBitLength**ï¼Œæ•°æ®ä¸­å¿ƒä½é•¿ï¼Œå†³å®š DataCenterId çš„æœ€å¤§å€¼ï¼Œ**é»˜è®¤å€¼ä¸º0**ï¼Œè¡¨ç¤ºä¸å¼€å¯åŒºåˆ†æ•°æ®ä¸­å¿ƒåŠŸèƒ½ï¼Œå–å€¼èŒƒå›´[0,6]ã€‚

â„ **WorkerId**ï¼Œæœºå™¨ç ï¼Œ**æœ€é‡è¦å‚æ•°**ï¼Œ**é»˜è®¤å€¼0**ï¼Œå¿…é¡» **å…¨å±€å”¯ä¸€**ï¼ˆæˆ–ç›¸åŒ DataCenterId å†…å”¯ä¸€ï¼‰ï¼Œå¿…é¡» **ç¨‹åºè®¾å®š**ï¼Œç¼ºçœæ¡ä»¶ï¼ˆWorkerIdBitLengthå–é»˜è®¤å€¼ï¼‰æ—¶æœ€å¤§å€¼63ï¼Œç†è®ºæœ€å¤§å€¼ 2^WorkerIdBitLength-1ï¼ˆä¸åŒå®ç°è¯­è¨€å¯èƒ½ä¼šé™å®šåœ¨ 65535 æˆ– 32767ï¼ŒåŸç†åŒ WorkerIdBitLength è§„åˆ™ï¼‰ã€‚ä¸åŒæœºå™¨æˆ–ä¸åŒåº”ç”¨å®ä¾‹ **ä¸èƒ½ç›¸åŒ**ï¼Œä½ å¯é€šè¿‡åº”ç”¨ç¨‹åºé…ç½®è¯¥å€¼ï¼Œä¹Ÿå¯é€šè¿‡è°ƒç”¨å¤–éƒ¨æœåŠ¡è·å–å€¼ã€‚é’ˆå¯¹è‡ªåŠ¨æ³¨å†ŒWorkerIdéœ€æ±‚ï¼Œæœ¬ç®—æ³•æä¾›é»˜è®¤å®ç°ï¼šé€šè¿‡ redis è‡ªåŠ¨æ³¨å†Œ WorkerId çš„åŠ¨æ€åº“ï¼Œè¯¦è§â€œTools\AutoRegisterWorkerIdâ€ã€‚

â„ ***WorkerIdBitLength***ï¼Œæœºå™¨ç ä½é•¿ï¼Œå†³å®š WorkerId çš„æœ€å¤§å€¼ï¼Œ**é»˜è®¤å€¼1**ï¼Œå–å€¼èŒƒå›´ [1, 19]ï¼Œå®é™…ä¸Šæœ‰äº›è¯­è¨€é‡‡ç”¨ æ— ç¬¦å· ushort (uint16) ç±»å‹æ¥æ”¶è¯¥å‚æ•°ï¼Œæ‰€ä»¥æœ€å¤§å€¼æ˜¯16ï¼Œå¦‚æœæ˜¯é‡‡ç”¨ æœ‰ç¬¦å· short (int16)ï¼Œåˆ™æœ€å¤§å€¼ä¸º15ã€‚

**ç‰¹åˆ«æç¤º**ï¼šå¦‚æœä¸€å°æœåŠ¡å™¨éƒ¨ç½²å¤šä¸ªç‹¬ç«‹æœåŠ¡ï¼Œéœ€è¦ä¸ºæ¯ä¸ªæœåŠ¡æŒ‡å®šä¸åŒçš„ WorkerIdã€‚

â„ ***SeqBitLength***ï¼Œåºåˆ—æ•°ä½é•¿ï¼Œ**é»˜è®¤å€¼6**ï¼Œå–å€¼èŒƒå›´ [3, 21]ï¼ˆå»ºè®®ä¸å°äº4ï¼‰ï¼Œå†³å®šæ¯æ¯«ç§’åŸºç¡€ç”Ÿæˆçš„IDä¸ªæ•°ã€‚è§„åˆ™è¦æ±‚ï¼šWorkerIdBitLength + SeqBitLength + DataCenterIdBitLength <= 22ã€‚

â„ ***MinSeqNumber***ï¼Œæœ€å°åºåˆ—æ•°ï¼Œ**é»˜è®¤å€¼5**ï¼Œå–å€¼èŒƒå›´ [5, MaxSeqNumber]ï¼Œæ¯æ¯«ç§’çš„å‰5ä¸ªåºåˆ—æ•°å¯¹åº”ç¼–å·0-4æ˜¯ä¿ç•™ä½ï¼Œå…¶ä¸­0æ˜¯æ‰‹å·¥æ’å…¥æ–°å€¼é¢„ç•™ä½ï¼Œ1-4æ˜¯æ—¶é—´å›æ‹¨ç›¸åº”é¢„ç•™ä½ã€‚

â„ ***MaxSeqNumber***ï¼Œæœ€å¤§åºåˆ—æ•°ï¼Œè®¾ç½®èŒƒå›´ [MinSeqNumber, 2^SeqBitLength-1]ï¼Œ**é»˜è®¤å€¼0**ï¼ŒçœŸå®æœ€å¤§åºåˆ—æ•°å–æœ€å¤§å€¼ï¼ˆ2^SeqBitLength-1ï¼‰ï¼Œä¸ä¸º0æ—¶ï¼Œå–å…¶ä¸ºçœŸå®æœ€å¤§åºåˆ—æ•°ï¼Œä¸€èˆ¬æ— éœ€è®¾ç½®ï¼Œé™¤éå¤šæœºå…±äº«WorkerIdåˆ†æ®µç”ŸæˆIDï¼ˆæ­¤æ—¶è¿˜è¦æ­£ç¡®è®¾ç½®æœ€å°åºåˆ—æ•°ï¼‰ã€‚



tipsï¼š

``` java
å…³äºè§„åˆ™ï¼šDataCenterIdBitLength + WorkerIdBitLength + SeqBitLength <= 22ï¼Œæˆ‘ä»¬idé‡‡ç”¨longåŸºæœ¬ç±»å‹ï¼Œä¹‹æ‰€ä»¥å®šä¹‰æ˜¯å› ä¸ºæˆ‘ä»¬éœ€è¦é¢„ç•™ä¸€äº›bitç»™æ¯«ç§’æ•°å ä½ï¼Œå› æ­¤ï¼Œå¦‚æœä½ éœ€è¦çº¿ä¸Šä½¿ç”¨ï¼Œè¯·è®¡ç®—æ¸…æ¥šåœ¨ä½ çš„éœ€æ±‚ä¸‹ï¼Œè¯¥å®ä¾‹èƒ½è·‘å¤šä¹…ã€‚å¦‚æœè¿‡äºåºå¤§ï¼Œè¯·ä½¿ç”¨Stringç±»å‹æˆ–è€…BigIntegerç±»å‹é‡å†™ã€‚
```



#### 5.4ã€å…³äºåŠ¨æ€é…ç½®çš„é—®é¢˜



##### 5.4.1ã€åŠ¨æ€åŠ è½½é…ç½®

å½“ä½ ä½¿ç”¨åŠ¨æ€åŠ è½½é…ç½®æ—¶ï¼Œå¦‚æœä½ åœ¨é…ç½®ä¸­å¿ƒé…ç½®æ–‡ä»¶ä¸­æ³¨é‡Šæ‰äº†æŸä¸ªé…ç½®ï¼Œä»–æ˜¯ä¸ä¼šæ¢å¤é»˜è®¤é…ç½®çš„ï¼Œè¿™å’ŒåŠ¨æ€é…ç½®åº•å±‚æœ‰å…³ï¼Œè¿™é‡Œå°±ä¸è¿‡å¤šæè¿°ã€‚

å› æ­¤ï¼Œåœ¨ä½ ä½¿ç”¨åŠ¨æ€é…ç½®çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¼ºçƒˆå»ºè®®å°†æ‰€æœ‰çš„é…ç½®éƒ½é…ç½®ä¸Šå»ï¼Œå¹¶æŒ‰éœ€ä¿®æ”¹æˆä½ é¢„æœŸçš„é…ç½®ï¼Œè€Œä¸æ˜¯æ³¨é‡Šæ‰ï¼Œå› ä¸ºå°±ç®—æ³¨é‡Šæ‰ä¹Ÿä¸ä¼šå†å»ä½¿ç”¨é»˜è®¤é…ç½®äº†ã€‚

å®˜æ–¹é»˜è®¤é…ç½®å¦‚ä¸‹ï¼š

``` yaml
wfg:
# è¯·ä¸€å®šæ³¨æ„ï¼ WorkerIdBitLength + SeqBitLength + DataCenterIdBitLength <= 22
  # 1è¡¨ç¤ºé›ªèŠ±æ¼‚ç§»ç®—æ³•ï¼Œ2è¡¨ç¤ºä¼ ç»Ÿé›ªèŠ±ç®—æ³•
  Method: 1
  # åŸºç¡€æ—¶é—´ï¼Œä¸º2022-01-01 00:00:00
  baseTime: 1640966400000
  # æ•°æ®ä¸­å¿ƒid
  DataCenterId: 0
  # æ•°æ®ä¸­å¿ƒidä½é•¿ï¼Œé»˜è®¤ä¸º0è¡¨ç¤ºä¸å¼€å¯æ•°æ®ä¸­å¿ƒidåŠŸèƒ½
  DataCenterIdBitLength: 0
  # æœºå™¨ç ï¼ˆå½“å‰ç³»ç»Ÿçš„æœºå™¨ç ï¼‰
  WorkerId: 0
  # æœºå™¨ç ä½é•¿ï¼ˆèƒ½è¡¨ç¤ºæœºå™¨ç çš„æœ€å¤§å€¼ï¼‰
  WorkerIdBitLength: 1
  # åºåˆ—æ•°ä½é•¿ï¼ˆèƒ½è¡¨ç¤ºæœºå™¨ç çš„æœ€å¤§åºåˆ—æ•°ï¼‰
  SeqBitLength: 6
  # æœ€å¤§åºåˆ—æ•°ï¼ˆå«ï¼‰
  MinSeqNumber: 5
  # æœ€å°åºåˆ—æ•°ï¼ˆå«ï¼‰
  MaxSeqNumber: 0
  # æœ€å¤§æ¼‚ç§»æ¬¡æ•°ï¼Œä¸è®¡ç®—èƒ½åŠ›æœ‰å…³
  TopOverCostCount: 2000
```



##### 5.4.2ã€å¼•å…¥åŠ¨æ€é…ç½®åŒ…æŠ¥é”™

å¼•å…¥æ™®é€šçš„ä¾èµ–åŒ…ä¸æŠ¥é”™ï¼Œä½†æ˜¯å¾ˆæœ‰å¯èƒ½å¼•å…¥åŠ¨æ€é…ç½®åŒ…ä¹‹åå°±æŠ¥é”™äº†ï¼Ÿ

å¾ˆå¤§å¯èƒ½æ˜¯ spring-boot ä¸ spring-cloud ç‰ˆæœ¬ä¸å¯¹åº”ã€‚

åŠ¨æ€é…ç½®æ˜¯ä¾èµ– spring-cloud æ ¸å¿ƒæ³¨è§£`@RefreshScope`å®ç°çš„ï¼Œå› æ­¤æˆ‘ä»¬å¼•å…¥äº† `spring-cloud-context-3.1.2` ç‰ˆæœ¬ï¼Œä½†åšè¿‡å¾®æœåŠ¡çš„æœ‹å‹éƒ½çŸ¥é“ï¼Œspring-bootä¸spring-cloudç‰ˆæœ¬éœ€è¦é«˜åº¦å¯¹åº”ï¼Œå› æ­¤å¯èƒ½ `spring-cloud-context-3.1.2` å¯èƒ½ä¸ä½ é¡¹ç›®çš„ spring-boot ç‰ˆæœ¬ä¸å¯¹åº”ï¼Œéœ€ç§»é™¤æ—§ç‰ˆæœ¬ï¼Œæˆ–å¼•å…¥ä¸ä½  spring-boot ç‰ˆæœ¬å¯¹åº”çš„ spring-cloud-context ç‰ˆæœ¬

å…¶äºŒï¼Œæˆ‘ä»¬ç”±äºè‡ªåŠ¨é…ç½®åœ¨spring-2.7.0åšå‡ºè¾ƒå¤§æ”¹å˜ï¼Œå› æ­¤æš‚æ—¶æ²¡æœ‰é€‚é…ã€‚å¦‚æœæ‚¨çš„springç‰ˆæœ¬ä¸º2.7.0ï¼Œè¯·é™ä½springç‰ˆæœ¬ä½¿ç”¨ã€‚

### 6ã€å…¶ä»–ç»†èŠ‚



#### 6.1ã€idç»„æˆ

- æœ¬ç®—æ³•ç”Ÿæˆçš„IDç”±3éƒ¨åˆ†ç»„æˆï¼ˆæ²¿ç”¨é›ªèŠ±ç®—æ³•å®šä¹‰ï¼‰ï¼š
- +---------------------------------------------------------------=------------------------+
- | 1.ç›¸å¯¹åŸºç¡€æ—¶é—´çš„æ—¶é—´å·® | 2.DataCenterIdæ•°æ®ä¸­å¿ƒid |3.WorkerIdæœºå™¨ç  | 4.åºåˆ—æ•° |
- +--------------------===-----------------------------------------------------------------+



å½“ç„¶ä¸‹å›¾å¹¶æ²¡æœ‰DataCenterIdæ•°æ®ä¸­å¿ƒidï¼Œä½†å…¶å®ç±»ä¼¼äºWorkerIdçš„ã€‚

![è¾“å…¥å›¾ç‰‡è¯´æ˜](doc/picture/2.png)



#### 6.2ã€å¼‚å¸¸å¤„ç†

`IdGeneratorException`ä¸ºæ­¤idç”Ÿæˆå™¨å”¯ä¸€ä¸”é»˜è®¤çš„å¼‚å¸¸ç±»ï¼Œä»–ç»§æ‰¿äº†`RuntimeException`ï¼Œå‡å¦‚ä½ éœ€è¦æ•è·å¼‚å¸¸ï¼Œè¯·æ•è·å®ƒã€‚



#### 6.3ã€é›†æˆç®—æ³•

1ï¸âƒ£ ç”¨å•ä¾‹æ¨¡å¼è°ƒç”¨ã€‚å¤–éƒ¨é›†æˆæ–¹ä½¿ç”¨æ›´å¤šçš„å®ä¾‹å¹¶è¡Œè°ƒç”¨æœ¬ç®—æ³•ï¼Œä¸ä¼šå¢åŠ IDäº§å‡ºæ•ˆèƒ½ï¼Œå› ä¸ºæœ¬ç®—æ³•é‡‡ç”¨å•çº¿ç¨‹ç”ŸæˆIDã€‚

2ï¸âƒ£ æŒ‡å®šå”¯ä¸€çš„ WorkerIdã€‚å¿…é¡»ç”±å¤–éƒ¨ç³»ç»Ÿç¡®ä¿ WorkerId çš„å…¨å±€å”¯ä¸€æ€§ï¼Œå¹¶èµ‹å€¼ç»™æœ¬ç®—æ³•å…¥å£æ–¹æ³•ã€‚

3ï¸âƒ£ å•æœºå¤šå®ä¾‹éƒ¨ç½²æ—¶ä½¿ç”¨ä¸åŒ WorkerIdã€‚å¹¶éæ‰€æœ‰å®ç°éƒ½æ”¯æŒè·¨è¿›ç¨‹çš„å¹¶å‘å”¯ä¸€ï¼Œä¿é™©èµ·è§ï¼Œåœ¨åŒä¸€ä¸»æœºä¸Šéƒ¨ç½²å¤šåº”ç”¨å®ä¾‹æ—¶ï¼Œè¯·ç¡®ä¿å„ WorkerId å”¯ä¸€ã€‚

4ï¸âƒ£ å¼‚å¸¸å¤„ç†ã€‚ç®—æ³•ä¼šæŠ›å‡ºæ‰€æœ‰ Exceptionï¼Œå¤–éƒ¨ç³»ç»Ÿåº” catch å¼‚å¸¸å¹¶åšå¥½åº”å¯¹å¤„ç†ï¼Œä»¥å…å¼•å‘æ›´å¤§çš„ç³»ç»Ÿå´©æºƒã€‚

5ï¸âƒ£ è®¤çœŸç†è§£ IdGeneratorOptions çš„å®šä¹‰ï¼Œè¿™å¯¹é›†æˆå’Œä½¿ç”¨æœ¬ç®—æ³•æœ‰å¸®åŠ©ã€‚

6ï¸âƒ£ ä½¿ç”¨é›ªèŠ±æ¼‚ç§»ç®—æ³•ã€‚è™½ç„¶ä»£ç é‡ŒåŒ…å«äº†ä¼ ç»Ÿé›ªèŠ±ç®—æ³•çš„å®šä¹‰ï¼Œå¹¶ä¸”ä½ å¯ä»¥åœ¨å…¥å£å¤„æŒ‡å®šï¼ˆMethod=2ï¼‰æ¥å¯ç”¨ä¼ ç»Ÿç®—æ³•ï¼Œä½†ä»å»ºè®®ä½ ä½¿ç”¨é›ªèŠ±æ¼‚ç§»ç®—æ³•ï¼ˆMethod=1ï¼Œé»˜è®¤çš„ï¼‰ï¼Œæ¯•ç«Ÿå®ƒå…·æœ‰æ›´å¥½çš„ä¼¸ç¼©åŠ›å’Œæ›´é«˜çš„æ€§èƒ½ã€‚

7ï¸âƒ£ ä¸è¦ä¿®æ”¹æ ¸å¿ƒç®—æ³•ã€‚æœ¬ç®—æ³•å†…éƒ¨å‚æ•°è¾ƒå¤šï¼Œé€»è¾‘è¾ƒä¸ºå¤æ‚ï¼Œåœ¨ä½ å°šæœªæŒæ¡æ ¸å¿ƒé€»è¾‘æ—¶ï¼Œè¯·å‹¿ä¿®æ”¹æ ¸å¿ƒä»£ç ä¸”ç”¨äºç”Ÿäº§ç¯å¢ƒï¼Œé™¤éé€šè¿‡å¤§é‡ç»†è‡´ã€ç§‘å­¦çš„æµ‹è¯•éªŒè¯ã€‚

8ï¸âƒ£ åº”ç”¨åŸŸå†…é…ç½®ç­–ç•¥ç›¸åŒã€‚å½“ç³»ç»Ÿè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œé¡¹ç›®éœ€è¦ä»ç¨‹åºæŒ‡å®š WorkerId è½¬åˆ°è‡ªåŠ¨æ³¨å†Œ WorkerId æ—¶ï¼Œè¯·ç¡®ä¿åŒä¸€åº”ç”¨åŸŸå†…æ‰€æœ‰åœ¨ç”¨å®ä¾‹é‡‡ç”¨ä¸€è‡´çš„é…ç½®ç­–ç•¥ï¼Œè¿™ä¸ä»…ä»…é’ˆå¯¹ WorkerIdï¼Œä¹ŸåŒ…å«å…¶ä»–æ‰€æœ‰é…ç½®å‚æ•°ã€‚

9ï¸âƒ£ ç®¡ç†å¥½æœåŠ¡å™¨æ—¶é—´ã€‚é›ªèŠ±ç®—æ³•ä¾èµ–ç³»ç»Ÿæ—¶é—´ï¼Œä¸è¦æ‰‹å·¥å¤§å¹…åº¦å›è°ƒæ“ä½œç³»ç»Ÿæ—¶é—´ã€‚å¦‚æœä¸€å®šè¦è°ƒæ•´ï¼Œåˆ‡è®°ï¼šç¡®ä¿æœåŠ¡å†æ¬¡å¯åŠ¨æ—¶çš„ç³»ç»Ÿæ—¶é—´å¤§äºæœ€åä¸€æ¬¡å…³é—­æ—¶çš„æ—¶é—´ã€‚ï¼ˆæ³¨ï¼šä¸–ç•Œçº§æˆ–ç½‘ç»œçº§çš„æ—¶é—´åŒæ­¥æˆ–å›æ‹¨ï¼Œå¼•èµ·çš„ç³»ç»Ÿæ—¶é—´å°å¹…åº¦å˜åŒ–ï¼Œå¯¹æœ¬ç®—æ³•æ²¡å½±å“ï¼‰



#### 6.4ã€é…ç½®å˜æ›´

é…ç½®å˜æ›´æŒ‡æ˜¯ç³»ç»Ÿè¿è¡Œä¸€æ®µæ—¶é—´åï¼Œå†è°ƒæ•´è¿è¡Œå‚æ•°ï¼ˆIdGeneratorOptions é€‰é¡¹å€¼ï¼‰ï¼Œè¯·æ³¨æ„ï¼š

ğŸ”´ 1.æœ€é‡è¦çš„ä¸€æ¡åŸåˆ™æ˜¯ï¼šBaseTime **åªèƒ½å¾€å‰**ï¼ˆæ¯”è€å€¼æ›´å°ã€è·ç¦»ç°åœ¨æ›´è¿œï¼‰èµ‹å€¼ï¼ŒåŸå› æ˜¯å¾€åèµ‹å€¼æå¤§å¯èƒ½äº§ç”Ÿç›¸åŒçš„æ—¶é—´æˆ³ã€‚[**ä¸æ¨è**åœ¨ç³»ç»Ÿè¿è¡Œä¹‹åè°ƒæ•´ BaseTime]

ğŸ”´ 2.ä»»ä½•æ—¶å€™å¢åŠ  WorkerIdBitLength æˆ– SeqBitLengthï¼Œéƒ½æ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æ…ç”¨ â€œå‡å°â€çš„æ“ä½œï¼Œå› ä¸ºè¿™å¯èƒ½å¯¼è‡´åœ¨æœªæ¥æŸå¤©ç”Ÿæˆçš„ ID ä¸è¿‡å»è€é…ç½®æ—¶ç›¸åŒã€‚[å…è®¸åœ¨ç³»ç»Ÿè¿è¡Œä¹‹å**å¢åŠ **ä»»ä½•ä¸€ä¸ª BitLength å€¼]

ğŸ”´ 3.å¦‚æœå¿…é¡»å‡å° WorkerIdBitLength æˆ– SeqBitLength å…¶ä¸­çš„ä¸€é¡¹ï¼Œä¸€å®šè¦æ»¡è¶³ä¸€ä¸ªæ¡ä»¶ï¼šæ–°çš„ä¸¤ä¸ª BitLength ä¹‹å’Œè¦å¤§äº è€çš„å€¼ä¹‹å’Œã€‚[**ä¸æ¨è**åœ¨è¿è¡Œä¹‹åç¼©å°ä»»ä½•ä¸€ä¸ª BitLength å€¼]

ğŸ”´ 4.ä¸Šè¿°3æ¡è§„åˆ™ï¼Œå¹¶æœªåœ¨æœ¬ç®—æ³•å†…åšé€»è¾‘æ§åˆ¶ï¼Œé›†æˆæ–¹åº”æ ¹æ®ä¸Šè¿°è§„åˆ™åšå¥½å½±å“è¯„ä¼°ï¼Œç¡®è®¤æ— è¯¯åï¼Œå†å®æ–½é…ç½®å˜æ›´ã€‚



#### 6.5ã€æœ€ä½³å®è·µ

1. æœºå™¨ç è¯·åŠ¡å¿…å”¯ä¸€ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨redisè‡ªå¢ç»“åˆnacos-configæˆ–å…¶ä»–æ–¹æ³•è¿›è¡Œè‡ªåŠ¨é…ç½®ã€‚ä¹Ÿå¯ä»¥ä½¿ç”¨è¯¥ç®—æ³•æœ¬èº«ç­‰ç‰¹æ€§è¿›è¡Œk8sé›†æˆã€‚
2. åºæ•°ä½ç›´æ¥å†³å®šäº†æœ¬ç®—æ³•ä¸€æ¯«ç§’å†…èƒ½å¤Ÿç”Ÿæˆå¤šå°‘idï¼Œå¦‚æœè¶…è¿‡æ­¤æ•°é‡ï¼Œåˆ™ä¼šé˜»å¡ä½ã€‚è¯·åŠ¡å¿…æµ‹è¯•å¥½ä½ çš„å¹¶å‘ã€‚
2. æœ¬åŒ…æ”¯æŒåŠ¨æ€é…ç½®åŠ è½½beanï¼Œä½†æˆ‘ä»¬å¼ºçƒˆå»ºè®®åŠ¨æ€é…ç½®ä¸­å¿ƒå°†æ‰€æœ‰é…ç½®éƒ½é…ç½®ä¸Šï¼Œè€Œä¸æ˜¯ä¸é…ç½®è€Œä½¿ç”¨é»˜è®¤ã€‚